#include <windows.h>
#include <stdio.h>
#include <tlhelp32.h>

BOOL CheckForVM() {
    char hypervisor[13];
    int cpuInfo[4] = { -1 };

    __cpuid(cpuInfo, 1);
    if ((cpuInfo[2] >> 31) & 1) {
        __cpuid(cpuInfo, 0x40000000);
        memcpy(hypervisor, &cpuInfo[1], 4);
        memcpy(hypervisor + 4, &cpuInfo[2], 4);
        memcpy(hypervisor + 8, &cpuInfo[3], 4);
        hypervisor[12] = '\0';
        if (strcmp(hypervisor, "Microsoft Hv") == 0 ||
            strcmp(hypervisor, "VMwareVMware") == 0 ||
            strcmp(hypervisor, "XenVMMXenVMM") == 0 ||
            strcmp(hypervisor, "prl hyperv") == 0 ||
            strcmp(hypervisor, "VBoxVBoxVBox") == 0) {
            return TRUE;
        }
    }
    return FALSE;
}


int main() {
    if (CheckForVM()) {
        printf("Virtual Machine detected via hypervisor check.\n");
        return TRUE;
    }

    return 0;

}