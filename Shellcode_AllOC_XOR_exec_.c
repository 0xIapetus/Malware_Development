// Piece of self modifying code,
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <stdint.h>
#include <unistd.h>
#include <sys/mman.h>

// int myFunc(int num1, int num2) {
//  return num1 + num2;

// This function above correlates to this byte code

// unsigned char yourCode[] = {
// 0x55, 0x48, 0x89, 0xe5, 0x89, 0x7d, 0xfc, 0x89, 0x75, 0xf8,
//  0x8b , 0x55, 0xfc ,0x8b, 0x45, 0xf8, 0x01, 0xd0, 0x5d, 0xc3
// };

void xorEncryptDecrypt(unsigned char *data, size_t dataLen, unsigned char key) {
    for (size_t i = 0; i < dataLen; i++) {
        data[i] ^= key; // XOR each byte with the key
      
    }

}

int main() {

// Encrytped with xor 0xAA bytes :
unsigned char yourCode[] = {
0xff, 0xe2,  0x23,  0x4f,  0x23,  0xd7, 0x56,  0x23,  0xdf,  0x52,  0x21,  0xff, 0x56,
 0x21, 0xef,  0x52,  0xab, 0x7a,  0xf7, 0x69

};

// XOR DECRYPTION
size_t len = sizeof(yourCode) / sizeof(yourCode[0]);
unsigned char key = 0xAA; // XOR key
xorEncryptDecrypt(yourCode, len, key);

 // allocate memory to copy our function code into
 unsigned char *funcRaw = malloc(sizeof(yourCode));
 for (int i = 0; i < sizeof(yourCode); i++)
 funcRaw[i] = yourCode[i];

 // Find the memory address at the start of this memory page
 void *page = (void *)((uintptr_t)funcRaw & ~(getpagesize() - 1));

 // Set the page executable
 mprotect(page, getpagesize(), PROT_WRITE | PROT_EXEC);

 // declare a function pointer 'func' that takes 2 ints and returns an int
 int (*func)(int, int);

 // cast the pointer to the copied memory into the function pointer 'func'
 func = (int (*)(int, int))funcRaw;

 int param1 = 10; int param2 = 15;
 // call the new piece of code as a function
 int funcResult = func(param1, param2);
 // print the result
 printf("yourCode(%d, %d) = %d\n", param1, param2, funcResult);
}


